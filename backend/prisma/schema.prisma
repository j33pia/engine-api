generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --------------------------------------
// SaaS Core (Software House Management)
// --------------------------------------

model Partner {
  id             String   @id @default(uuid())
  name           String
  cnpj           String?  @unique
  email          String?
  phone          String?
  webhookUrl     String?  // URL para receber notificações
  webhookSecret  String?  // Secret para assinatura HMAC
  webhookEvents  Json?    // Array de eventos assinados
  apiKey         String   @unique @default(uuid()) // Chave Mestra da Software House

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  users          User[]
  issuers        Issuer[]
  subscription   Subscription?
  metrics        UsageMetric[]
  webhookDeliveries WebhookDelivery[]
  auditLogs      AuditLog[]

  @@map("partners")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   // Hashed
  role      String   @default("ADMIN") // ADMIN, DEVELOPER, FINANCE
  
  partnerId String?
  partner   Partner? @relation(fields: [partnerId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

// --------------------------------------
// Billing & Plans (Future Proofing)
// --------------------------------------

model Plan {
  id               String   @id @default(uuid())
  name             String   // e.g. "Basic", "Pro", "Enterprise"
  price            Decimal  @default(0)
  includedInvoices Int      @default(0)
  pricePerExtra    Decimal  @default(0)
  
  createdAt        DateTime @default(now())
  
  subscriptions    Subscription[]

  @@map("plans")
}

model Subscription {
  id        String   @id @default(uuid())
  status    String   @default("ACTIVE") // ACTIVE, CANCELED, PAST_DUE
  
  partnerId String   @unique
  partner   Partner  @relation(fields: [partnerId], references: [id])
  
  planId    String
  plan      Plan     @relation(fields: [planId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("subscriptions")
}

model UsageMetric {
  id        String   @id @default(uuid())
  period    String   // Format: "YYYY-MM"
  count     Int      @default(0)
  
  partnerId String
  partner   Partner  @relation(fields: [partnerId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([partnerId, period])
  @@map("usage_metrics")
}

// Audit Logging for Multi-tenancy
model AuditLog {
  id        String   @id @default(uuid())
  
  partnerId String
  partner   Partner  @relation(fields: [partnerId], references: [id])
  
  userId    String?  // Optional: logged-in user
  action    String   // e.g., "POST /nfe", "DELETE /companies/123"
  status    String   @default("SUCCESS") // SUCCESS, ERROR
  duration  Int?     // Request duration in ms
  ip        String?
  metadata  Json?    // Sanitized request body
  
  createdAt DateTime @default(now())
  
  @@index([partnerId])
  @@index([createdAt])
  @@map("audit_logs")
}

// Eventos Fiscais (CC-e, Cancelamento, etc)
model FiscalEvent {
  id               String   @id @default(uuid())
  
  invoiceId        String
  invoice          Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  eventType        String   // CCE, CANCELAMENTO, MANIFESTACAO
  sequence         Int      // Sequência do evento (para CC-e)
  description      String   @db.Text // Correção ou justificativa
  protocol         String?  // Protocolo SEFAZ
  xml              String?  @db.Text // XML do evento
  
  createdAt        DateTime @default(now())
  
  @@index([invoiceId])
  @@map("fiscal_events")
}

// --------------------------------------
// Fiscal Core (The Invoice Emitters)
// --------------------------------------

model Issuer {
  id           String    @id @default(uuid())
  cnpj         String    @unique
  name         String
  tradeName    String?   // Nome Fantasia
  ie           String?   // Inscrição Estadual
  im           String?   // Inscrição Municipal
  crt          Int       @default(1) // 1=Simples Nacional, 3=Regime Normal
  email        String?
  phone        String?

  // Address
  cep          String?
  address      String?
  number       String?
  complement   String?
  neighborhood String?
  city         String?
  state        String?
  ibgeCode     String?   // Código IBGE da Cidade

  // Certificate Info
  certFilename String?
  certPassword String?
  certExpiry   DateTime?
  
  // NFCe - CSC (Código de Segurança do Contribuinte)
  csc          String?   // Token CSC para NFCe
  cscId        String?   // ID do Token CSC
  
  // Relations
  partnerId    String?   
  partner      Partner?  @relation(fields: [partnerId], references: [id])
  
  invoices     Invoice[]
  products     Product[]
  customers    Customer[]
  mdfes        Mdfe[]
  nfses        Nfse[]
  
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@map("issuers")
}

enum InvoiceStatus {
  CREATED
  SIGNED
  TRANSMITTING
  AUTHORIZED
  REJECTED
  CANCELED
  ERROR
}

model Invoice {
  id          String        @id @default(uuid())
  
  // Fiscal Data
  accessKey   String?       @unique // Chave de Acesso (só existe após gerar XML)
  number      Int
  series      Int
  model       String        @default("55") // 55 (NFe) or 65 (NFCe)
  
  // Values
  amount      Decimal
  
  // Destination
  destCNPJ    String?
  destName    String?
  
  // Storage Paths
  xmlPath     String?
  pdfPath     String?
  
  // Flow Control
  status      InvoiceStatus @default(CREATED)
  sefaMult    String?       // Mensagem de retorno da SEFAZ
  
  // Relations
  issuerId    String
  issuer      Issuer        @relation(fields: [issuerId], references: [id])
  
  customerId  String?
  customer    Customer?     @relation(fields: [customerId], references: [id])
  
  items       InvoiceItem[]
  fiscalEvents FiscalEvent[]
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@map("invoices")
  @@index([issuerId])
  @@index([accessKey])
  @@index([createdAt])
}

model Customer {
  id           String   @id @default(uuid())
  issuerId     String
  issuer       Issuer   @relation(fields: [issuerId], references: [id])

  document     String   // CPF ou CNPJ
  name         String
  email        String?
  phone        String?
  
  // Address
  cep          String?
  address      String?
  number       String?
  complement   String?
  neighborhood String?
  city         String?
  state        String?

  invoices     Invoice[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([issuerId, document])
  @@map("customers")
}

model Product {
  id           String   @id @default(uuid())
  issuerId     String
  issuer       Issuer   @relation(fields: [issuerId], references: [id])

  code         String   // Código interno do produto
  ean          String?  // Código de Barras (GTIN)
  description  String
  ncm          String?
  cest         String?
  cfop         String?
  unit         String?  // UN
  
  price        Decimal  // Preço atual
  
  items        InvoiceItem[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([issuerId, code])
  @@index([ean])
  @@map("products")
}

model InvoiceItem {
  id           String   @id @default(uuid())
  invoiceId    String
  invoice      Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  productId    String?
  product      Product? @relation(fields: [productId], references: [id])

  itemCode     String
  description  String
  ean          String?
  ncm          String?
  quantity     Decimal
  unitPrice    Decimal
  totalPrice   Decimal

  createdAt    DateTime @default(now())

  @@map("invoice_items")
}

// ======================
// MDFe (Modelo 58)
// ======================

enum MdfeStatus {
  CREATED
  AUTHORIZED
  REJECTED
  CANCELED
  CLOSED       // Encerrado
}

model Mdfe {
  id            String      @id @default(uuid())
  
  accessKey     String?     @unique
  number        Int
  series        Int         @default(1)
  
  // Dados da viagem
  ufStart       String      // UF de início (SP, MG, etc)
  ufEnd         String      // UF de destino
  dtViagem      DateTime    // Data/hora início viagem
  
  // Veículo
  placaVeiculo  String
  renavam       String?
  tara          Int?        // Peso do veículo vazio (kg)
  capKg         Int?        // Capacidade em KG
  capM3         Int?        // Capacidade em M3
  
  // Motorista
  cpfMotorista  String
  nomeMotorista String
  
  // Documentos vinculados (JSON array)
  // [{chNFe: "35...", tpDoc: "1"}] 1=NFe, 2=CTe
  documentos    Json
  
  // Totais
  qNFe          Int         @default(0)  // Qtd NFe vinculadas
  qCTe          Int         @default(0)  // Qtd CTe vinculadas
  vCarga        Decimal     @default(0)  // Valor total carga
  
  status        MdfeStatus  @default(CREATED)
  protocol      String?
  xmlPath       String?
  pdfPath       String?
  
  // Encerramento
  dtEncerramento DateTime?
  ufEncerramento String?
  
  issuerId      String
  issuer        Issuer      @relation(fields: [issuerId], references: [id])
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@map("mdfes")
}

// ======================
// Webhooks
// ======================

model WebhookDelivery {
  id          String   @id @default(uuid())
  
  partnerId   String
  partner     Partner  @relation(fields: [partnerId], references: [id])
  
  eventType   String   // invoice.authorized, invoice.rejected, etc.
  payload     Json     // Full event payload
  status      String   @default("pending") // pending, success, failed
  attempts    Int      @default(0)
  lastError   String?  @db.Text
  
  createdAt   DateTime @default(now())
  deliveredAt DateTime?
  
  @@index([partnerId])
  @@index([status])
  @@map("webhook_deliveries")
}

// ======================
// NFSe - Nota Fiscal de Serviço
// ======================

model Nfse {
  id                String   @id @default(uuid())
  number            String   // Número da NFSe
  verificationCode  String?  // Código de verificação
  status            String   @default("CREATED") // CREATED, AUTHORIZED, CANCELED
  
  // Serviço
  codigoMunicipio   String   // Código IBGE do município
  itemListaServico  String   // Item da LC 116/2003
  discriminacao     String   @db.Text
  valorServicos     Decimal  @db.Decimal(15, 2)
  valorDeducoes     Decimal? @db.Decimal(15, 2)
  valorIss          Decimal? @db.Decimal(15, 2)
  aliquotaIss       Decimal? @db.Decimal(5, 4)
  
  // Tomador
  tomadorCnpjCpf    String
  tomadorRazao      String
  
  // XML
  xmlContent        String?  @db.Text
  
  // Relacionamentos
  issuerId          String
  issuer            Issuer   @relation(fields: [issuerId], references: [id])
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  authorizedAt      DateTime?
  canceledAt        DateTime?
  
  @@index([issuerId])
  @@index([codigoMunicipio])
  @@index([status])
  @@map("nfses")
}

