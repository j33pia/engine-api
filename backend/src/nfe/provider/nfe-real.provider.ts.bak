import { Injectable, Logger } from '@nestjs/common';
import { INfeProvider, ServiceStatus } from './nfe-provider.interface';
// import { ACBrLibNFe } from '@projetoacbr/acbrlib-nfe-node';
import { AcbrConfigService } from '../acbr-config.service';
import { CryptoUtil } from '../../common/utils/crypto.util';
import * as path from 'path';
import * as fs from 'fs';

@Injectable()
export class RealNfeProvider implements INfeProvider {
  private lib: any;
  private logger = new Logger(RealNfeProvider.name);

  constructor(private configService: AcbrConfigService) {
    // Initialize the library wrapper
  }

  async inicializar(): Promise<void> {
    return Promise.resolve();
  }

  async finalizar(): Promise<void> {
    return Promise.resolve();
  }

  private getLibInstance(): any {
    try {
      // CRITICAL: ACBrLib REQUIRES X11 display even in headless environment
      // Force DISPLAY to Xvfb virtual display before loading library
      if (!process.env.DISPLAY) {
        process.env.DISPLAY = ':99';
        this.logger.log('üñ•Ô∏è  Forcing DISPLAY=:99 for ACBrLib X11 requirement');
      }

      const libPath = '/app/acbrlib/x64/libacbrnfe64.so';
      const logPath = '/app/logs/acbr.log';

      // Dynamic Import with explicit path found in container structure
      // Structure: node_modules/@projetoacbr/acbrlib-nfe-node/dist/src/index.js
      const acbrModule = require('@projetoacbr/acbrlib-nfe-node/dist/src/index');
      this.logger.log(
        `ACBr Module Loaded: ${JSON.stringify(Object.keys(acbrModule))}`,
      );

      const ACBrLibNFe =
        acbrModule.ACBrLibNFe || acbrModule.default || acbrModule;

      if (typeof ACBrLibNFe !== 'function') {
        this.logger.error(
          `ACBrLibNFe is not a constructor! Type: ${typeof ACBrLibNFe}, Value: ${ACBrLibNFe}`,
        );
        if (acbrModule.ACBrLibNFe)
          this.logger.error(
            `acbrModule.ACBrLibNFe type: ${typeof acbrModule.ACBrLibNFe}`,
          );
      }

      // return new ACBrLibNFe(libPath, logPath);
      return new ACBrLibNFe(libPath, ''); // Try without log path to fix init error
    } catch (e) {
      this.logger.error('Failed to load ACBrLib', e);
      throw new Error('Falha ao carregar biblioteca fiscal ACBrLib.');
    }
  }

  async checkStatus(uf: string, cnpj: string): Promise<ServiceStatus> {
    // Status Check implementation...
    return {
      status: 'UP',
      message: 'Servi√ßo em Opera√ß√£o (ACBrLib Real/Linux)',
      uf,
      timestamp: new Date(),
    };
  }

  async emitir(json: any, issuer: any): Promise<any> {
    if (!issuer) throw new Error('Issuer context required for Real Emission');

    // Force DISPLAY for X11 requirement
    if (!process.env.DISPLAY) {
      process.env.DISPLAY = ':99';
      this.logger.log('üñ•Ô∏è  Setting DISPLAY=:99 for ACBrLib X11');
    }

    const lib = this.getLibInstance();

    try {
      this.logger.log(`üöÄ Iniciando Emissao Real ACBrLib para ${issuer.cnpj}`);

      // 1. INICIALIZAR - A biblioteca cria acbrlib.ini automaticamente
      this.logger.log('Step 1: Inicializando ACBrLib...');
      const iniPath = '/app/acbrlib.ini';
      const logPath = '/app/logs';

      if (lib.inicializar(iniPath, logPath) !== 0) {
        throw new Error('Falha ao inicializar ACBrLib');
      }
      this.logger.log('‚úÖ ACBrLib inicializada');

      // 2. CONFIGURAR CERTIFICADO via SetConfig
      this.logger.log('Step 2: Configurando certificado...');
      lib.configGravarValor('DFe', 'ArquivoPFX', issuer.certFilename);
      const decryptedPassword = await CryptoUtil.decrypt(issuer.certPassword);
      lib.configGravarValor('DFe', 'Senha', decryptedPassword);
      lib.configGravarValor('DFe', 'UF', issuer.state);
      lib.configGravar();
      this.logger.log('‚úÖ Certificado configurado');

      // 3. LIMPAR LISTA
      this.logger.log('Step 3: Limpando lista...');
      lib.limparLista();

      // 4. CARREGAR DADOS - Usando XML em vez de INI (bug na lib Node com datas)
      this.logger.log('Step 4: Carregando dados da NFe...');
      const nfeXML = this.buildMinimalNFeXML(json, issuer);

      this.logger.log(
        `DEBUG XML (primeiras 600 chars):\n${nfeXML.substring(0, 600)}`,
      );

      if (lib.carregarXML(nfeXML) !== 0) {
        throw new Error('Falha ao carregar dados da NFe via XML');
      }
      this.logger.log('‚úÖ Dados da NFe carregados');

      // 5. ASSINAR
      this.logger.log('Step 5: Assinando NFe...');
      if (lib.assinar() !== 0) {
        throw new Error('Falha ao assinar NFe');
      }
      this.logger.log('‚úÖ NFe assinada');

      // 6. VALIDAR
      this.logger.log('Step 6: Validando NFe...');
      if (lib.validar() !== 0) {
        throw new Error('Falha ao validar NFe');
      }
      this.logger.log('‚úÖ NFe validada');

      // 7. ENVIAR
      this.logger.log('Step 7: Enviando para SEFAZ...');
      const lote = 1;
      const imprimir = false;
      const sincrono = true;
      const zipado = false;

      if (lib.enviar(lote, imprimir, sincrono, zipado) !== 0) {
        throw new Error('Falha ao enviar NFe para SEFAZ');
      }
      this.logger.log('‚úÖ NFe enviada com sucesso!');

      // 8. OBTER RESULTADO
      const bufferLen = 9999;
      const buffer = Buffer.alloc(bufferLen);
      lib.obterXml(0, buffer, bufferLen);
      const xml = buffer.toString('utf8').replace(/\0/g, '');

      // Cleanup
      lib.finalizar();

      return {
        status: 'AUTHORIZED',
        message: 'NFe emitida com sucesso via ACBrLib',
        xml: xml,
      };
    } catch (e) {
      this.logger.error('‚ùå Erro na Emissao Real ACBrLib', e);
      try {
        lib.finalizar();
      } catch {}
      throw e;
    }
  }

  /**
   * Constr√≥i um XML m√≠nimo NFe 4.0 para teste
   * Workaround para bug na biblioteca ACBrLib Node que transforma datas em INI
   */
  private buildMinimalNFeXML(json: any, issuer: any): string {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    const dhEmi = `${year}-${month}-${day}T${hours}:${minutes}:${seconds}-03:00`;

    const cNF = Math.floor(Math.random() * 99999999);

    this.logger.log(`DEBUG dhEmi XML: ${dhEmi}`);

    return `<?xml version="1.0" encoding="UTF-8"?>
<NFe xmlns="http://www.portalfiscal.inf.br/nfe">
  <infNFe versao="4.00">
    <ide>
      <cUF>52</cUF>
      <cNF>${cNF}</cNF>
      <natOp>Venda de Mercadoria</natOp>
      <mod>55</mod>
      <serie>1</serie>
      <nNF>1</nNF>
      <dhEmi>${dhEmi}</dhEmi>
      <tpNF>1</tpNF>
      <idDest>1</idDest>
      <cMunFG>5208707</cMunFG>
      <tpImp>1</tpImp>
      <tpEmis>1</tpEmis>
      <cDV>0</cDV>
      <tpAmb>2</tpAmb>
      <finNFe>1</finNFe>
      <indFinal>0</indFinal>
      <indPres>1</indPres>
      <procEmi>0</procEmi>
      <verProc>NFe Engine v1.0</verProc>
    </ide>
    <emit>
      <CNPJ>${issuer.cnpj}</CNPJ>
      <xNome>${issuer.name}</xNome>
      <xFant>${issuer.name}</xFant>
      <enderEmit>
        <xLgr>${issuer.address || 'Rua Teste'}</xLgr>
        <nro>${issuer.number || 'S/N'}</nro>
        <xBairro>${issuer.neighborhood || 'Centro'}</xBairro>
        <cMun>5208707</cMun>
        <xMun>${issuer.city || 'Jandaia'}</xMun>
        <UF>${issuer.state || 'GO'}</UF>
        <CEP>${(issuer.cep || '75950000').replace(/\\D/g, '')}</CEP>
        <cPais>1058</cPais>
        <xPais>BRASIL</xPais>
      </enderEmit>
      <IE>${issuer.ie || ''}</IE>
      <CRT>1</CRT>
    </emit>
    <dest>
      <CPF>12345678900</CPF>
      <xNome>CONSUMIDOR FINAL</xNome>
      <indIEDest>9</indIEDest>
    </dest>
    <det nItem="1">
      <prod>
        <cProd>001</cProd>
        <cEAN>SEM GTIN</cEAN>
        <xProd>PRODUTO DE TESTE</xProd>
        <NCM>00000000</NCM>
        <CFOP>5102</CFOP>
        <uCom>UN</uCom>
        <qCom>1.0000</qCom>
        <vUnCom>100.00</vUnCom>
        <vProd>100.00</vProd>
        <cEANTrib>SEM GTIN</cEANTrib>
        <uTrib>UN</uTrib>
        <qTrib>1.0000</qTrib>
        <vUnTrib>100.00</vUnTrib>
        <indTot>1</indTot>
      </prod>
      <imposto>
        <ICMS>
          <ICMSSN102>
            <orig>0</orig>
            <CSOSN>102</CSOSN>
          </ICMSSN102>
        </ICMS>
        <PIS>
          <PISOutr>
            <CST>99</CST>
            <vBC>0.00</vBC>
            <pPIS>0.00</pPIS>
            <vPIS>0.00</vPIS>
          </PISOutr>
        </PIS>
        <COFINS>
          <COFINSOutr>
            <CST>99</CST>
            <vBC>0.00</vBC>
            <pCOFINS>0.00</pCOFINS>
            <vCOFINS>0.00</vCOFINS>
          </COFINSOutr>
        </COFINS>
      </imposto>
    </det>
    <total>
      <ICMSTot>
        <vBC>0.00</vBC>
        <vICMS>0.00</vICMS>
        <vICMSDeson>0.00</vICMSDeson>
        <vFCP>0.00</vFCP>
        <vBCST>0.00</vBCST>
        <vST>0.00</vST>
        <vFCPST>0.00</vFCPST>
        <vFCPSTRet>0.00</vFCPSTRet>
        <vProd>100.00</vProd>
        <vFrete>0.00</vFrete>
        <vSeg>0.00</vSeg>
        <vDesc>0.00</vDesc>
        <vII>0.00</vII>
        <vIPI>0.00</vIPI>
        <vIPIDevol>0.00</vIPIDevol>
        <vPIS>0.00</vPIS>
        <vCOFINS>0.00</vCOFINS>
        <vOutro>0.00</vOutro>
        <vNF>100.00</vNF>
      </ICMSTot>
    </total>
    <transp>
      <modFrete>9</modFrete>
    </transp>
    <pag>
      <detPag>
        <indPag>0</indPag>
        <tPag>01</tPag>
        <vPag>100.00</vPag>
      </detPag>
    </pag>
  </infNFe>
</NFe>`;
  }

  /**
   * Constr√≥i um INI m√≠nimo para teste baseado na documenta√ß√£o
   * TODO: Implementar builder completo em servi√ßo separado
   */
  private buildMinimalNFeINI(json: any, issuer: any): string {
    // Formato correto NFe: 2024-01-01T10:00:00-03:00
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    const dhEmi = `${year}-${month}-${day}T${hours}:${minutes}:${seconds}-03:00`;

    this.logger.log(`DEBUG dhEmi: ${dhEmi}`);

    return `[infNFe]
versao=4.00

[Identificacao]
cNF=12345678
natOp=Venda de Mercadoria
mod=55
serie=1
nNF=1
dhEmi=${dhEmi}
tpNF=1
idDest=1
tpAmb=2
tpImp=1
tpEmis=1
finNFe=1
indFinal=0
indPres=1
procEmi=0
verProc=NFe Engine v1.0

[Emitente]
CRT=${issuer.crt || 1}
CNPJCPF=${issuer.cnpj}
xNome=${issuer.name}
IE=${issuer.ie || ''}
xLgr=${issuer.address || 'Rua Teste'}
nro=${issuer.number || '1'}
xBairro=${issuer.neighborhood || 'Centro'}
cMun=${issuer.ibgeCode || '5208707'}
xMun=${issuer.city || 'Goiania'}
UF=${issuer.state || 'GO'}
CEP=${issuer.cep || '74000000'}
cPais=1058
xPais=BRASIL

[Destinatario]
CNPJCPF=12345678900
xNome=CONSUMIDOR FINAL
indIEDest=9

[Produto001]
cProd=001
cEAN=SEM GTIN
xProd=PRODUTO DE TESTE
NCM=00000000
CFOP=5102
uCom=UN
qCom=1.0000
vUnCom=100.00
vProd=100.00
uTrib=UN
qTrib=1.0000
vUnTrib=100.00
indTot=1

[ICMS001]
orig=0
CSOSN=102

[PIS001]
CST=99
vBC=0.00
pPIS=0.00
vPIS=0.00

[COFINS001]
CST=99
vBC=0.00
pCOFINS=0.00
vCOFINS=0.00

[Total]
vBC=0.00
vICMS=0.00
vBCST=0.00
vST=0.00
vProd=100.00
vFrete=0.00
vSeg=0.00
vDesc=0.00
vII=0.00
vIPI=0.00
vPIS=0.00
vCOFINS=0.00
vOutro=0.00
vNF=100.00

[pag001]
tPag=01
vPag=100.00
`;
  }
}
